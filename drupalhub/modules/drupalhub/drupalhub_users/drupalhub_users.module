<?php
/**
 * @file
 * Code for the drupalhub_users feature.
 */

include_once 'drupalhub_users.features.inc';

/**
 * Implements hook_menu().
 */
function drupalhub_users_menu() {
  $items = array();

  $items['drupalhub_users/update_about/%user/%ctools_js'] = array(
    'title' => 'Update about',
    'page callback' => 'drupalhub_users_update_about',
    'page arguments' => array(2,3),
    'access callback' => TRUE,
  );

  return $items;
}

/**
 * Page callback; Modal page for posting a question.
 */
function drupalhub_users_update_about($user, $js = TRUE) {
  drupalhub_core_modal_form(t('Add some info about your self'), 'drupalhub_users_update_about_form', $js, $user);
}

/**
 * Form callback; Update the user about form.
 */
function drupalhub_users_update_about_form($form, &$form_state) {
  ctools_include('user.pages', 'user', '');
  $user_form = drupal_get_form('user_profile_form', $form_state['additional']);
  $form['about'] = $user_form['field_about'];
  $form['about']['#after_build'][] = 'drupalhub_users_after_build';
  $form['about'][LANGUAGE_NONE][0]['#required'] = TRUE;
  $form['actions'] = array(
    '#type' => 'actions',
    'submit' => array(
      '#type' => 'submit',
      '#value' => t('Submit'),
    ),
  );

  return $form;
}

/**
 * Submitting the modal window.
 */
function drupalhub_users_update_about_form_submit(&$form, &$form_state) {
  $value = $form_state['values']['field_about'][LANGUAGE_NONE][0]['value'];
  $wrapper = entity_metadata_wrapper('user', $form_state['additional']);
  $wrapper->field_about->set(array('value' => $value));
  $wrapper->save();

  // Tell the browser to close the modal.
  $form_state['ajax_commands'][] = ctools_modal_command_dismiss();

  // Tell the browser to replace the old link with the new one.
  $form_state['ajax_commands'][] = ajax_command_replace('.pane-about', $value);
}

/**
 * Remove the text format element.
 */
function drupalhub_users_after_build($element) {
  hide($element['und'][0]['format']);
  return $element;
}

/**
 * Implement hook_theme().
 */
function drupalhub_users_theme() {
  return array(
    'drupalhub_users_login_form' => array(
      'render element' => 'form',
      'template' => 'login-form',
      'path' => drupal_get_path('module', 'drupalhub_users') . '/templates',
    ),
  );
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function drupalhub_users_form_user_login_alter(&$form, $form_state) {
  $form['#theme'] = 'drupalhub_users_login_form';
  $form['name']['#title'] = '';
  $form['pass']['#title'] = '';

  $form['name']['#show-required'] = FALSE;
  $form['pass']['#show-required'] = FALSE;
}

/**
 * Implements hook_ctools_plugins_directory().
 */
function drupalhub_users_ctools_plugin_directory($module, $plugin) {
  if ($module == 'ctools' && !empty($plugin)) {
    return "plugins/$plugin";
  }
}

/**
 * Implements hook_account_created().
 */
function drupalhub_users_user_insert(&$edit, $account, $category) {
  $message = message_create('new_user', array('uid' => $account->uid));
  $message->save();
}

/**
 * Implements hook_node_insert().
 */
function drupalhub_users_node_insert($node) {
  $message = message_create('created_node', array('uid' => $node->uid));
  $wrapper = entity_metadata_wrapper('message', $message);
  $wrapper->field_node->set($node);
  $wrapper->save();
}

/**
 * Implements hook_comment_insert().
 */
function drupalhub_users_comment_insert($comment) {
  $message = message_create('commented_to_node', array('uid' => $comment->uid));
  $wrapper = entity_metadata_wrapper('message', $message);
  $wrapper->field_comment->set($comment);
  $wrapper->save();
}

/**
 * Implements hook_votingapi_insert().
 */
function drupalhub_users_votingapi_insert($votes) {
  $vote = $votes[0];
  $wrapper = entity_metadata_wrapper($vote['entity_type'], $vote['entity_id']);
  $identifier = $wrapper->type() . ':' . $wrapper->getIdentifier();
  $uri = entity_uri($wrapper->type(), $wrapper->value());

  // Check if there any message for the entity the user just voted for.
  $query = new EntityFieldQuery();
  $count = $query
    ->entityCondition('entity_type', 'message')
    ->propertyCondition('uid', $vote['uid'])
    ->fieldCondition('field_entity_identifier', 'value', $identifier)
    ->count()
    ->execute();

  if ($count) {
    // The user already voted/down voted for the entity. We don't need to create
    // another message for that.
    return;
  }

  // Get default variables.
  $type = $wrapper->type() == 'comment' ? t('comment') : t('node');
  $label = $wrapper->label();
  $action = $vote['value'] === 1 ? t('Up voted') : t('Down voted');
  $uri = $uri['path'];

  // Create the message.
  $message = message_create('user_down_up_voted', array('uid' => $vote['uid']));
  $message->arguments = array(
    '@uri' => $uri,
    '@type' => $type,
    '@label' => $label,
    '@action' => $action,
  );
  $wrapper = entity_metadata_wrapper('message', $message);
  $wrapper->field_entity_identifier->set($identifier);
  $wrapper->save();
}

/**
 * Get the user picture.
 *
 * @param $user
 *   The user object.
 * @param $style_name
 *   The style name.
 *
 * @return string
 *   HTML of the user picture.
 */
function drupalhub_users_user_picture($user, $style_name) {
  $uri = $user->picture ? $user->picture->uri : file_load(variable_get('default_user_picture_fid'))->uri;
  return theme('image_style', array('path' => $uri, 'style_name' => $style_name));
}

/**
 * Implementing hook_preprocess_drupalhub_user().
 */
function drupalhub_users_preprocess_drupalhub_user(&$variables) {
  $menu = menu_get_item();

  if (path_is_admin($menu['path'])) {
    return;
  }

  drupal_add_js(drupal_get_path('module', 'drupalhub_users') . '/js/user.js');
  $user = reset($variables['display']->context)->data;
  $variables['image'] = drupalhub_users_user_picture($user, 'thumbnail_retina');
  $variables['name'] = $user->name;
}
